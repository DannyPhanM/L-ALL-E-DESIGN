{% liquid
    assign overlay_background = block.overlay_color
    if block.overlay_gradient != blank
      assign overlay_background = block.overlay_gradient
    endif
    assign uppercase_font = false
    assign bolder_font = false
    if settings.typography_preset == 'custom'
        if block.link_size == 'default' and settings.navigation_item_size == 'default'
            if settings.uppercase_body_s
                    assign uppercase_font = true
            endif
            if settings.bolder_font_body_s
                    assign bolder_font = true
            endif
        endif
    endif
%}
<div class="mega-menu--container mega-menu-{{ id }}" {{ mega_block.shopify_attributes }}>
    {% style %}
        .mega-menu-{{ id }} {
            --vertical-aligment: {{ block.vertical_text_alignment }};
            --horizontal-aligment: {{ block.horizontal_text_alignment }};
            --overlay-background: {{ overlay_background }};
            --overlay-opacity: {{ block.overlay_opacity | divided_by: 100.0 }};
            --content-color: {{ block.banner_content_color }};
            --columns: {{ block.columns }};
            --layout-text-color: 
            {{ settings.layout_text_color.red }},
            {{ settings.layout_text_color.green }}, 
            {{ settings.layout_text_color.blue }};
            --layout-background-color: 
            {{ settings.layout_background_color.red }},
            {{ settings.layout_background_color.green }},
            {{ settings.layout_background_color.blue }};
            --highlight-color: {{ block.highlight_menu_item_color.red }},
                {{ block.highlight_menu_item_color.green }},
                {{ block.highlight_menu_item_color.blue }};
            --accent-button-color: 
            {{ settings.accent_button_color.red }},
            {{ settings.accent_button_color.green }},
            {{ settings.accent_button_color.blue }};
        }
    {% endstyle %}
    <div class="list-menu-dropdown {% if block.swap_banner_position %}list-menu-dropdown--right{% endif %} {% if block.show_lines %}list-menu-dropdown--lines{% endif %} {%- if block.show_banner -%}list-menu-dropdown--with-banner{%- endif -%}">
        {% if block.menu_heading != blank %}
            {% liquid
                assign uppercase_font_title = false
                assign bolder_font_title = false
                if settings.typography_preset == 'custom'
                    if block.menu_heading_size == 'default'
                        if settings.uppercase_heading_xs
                                assign uppercase_font_title = true
                        endif
                        if settings.bolder_font_heading_xs
                                assign bolder_font_title = true
                        endif
                    endif
                endif
                assign heading_text = block.menu_heading
                assign final_text = ''
                assign split_text_curly = heading_text | split: '{'
                for part in split_text_curly
                    if part contains '}'
                        assign split_curly = part | split: '}'
                        assign styled_text = split_curly[0]
                        assign after_curly = split_curly[1]
                        assign final_text = final_text | append: '<span class="styled">' | append: styled_text | append: '</span>' | append: after_curly
                    else
                        assign final_text = final_text | append: part
                    endif
                endfor
            %}
            <h4 class="mega-menu__title custom-heading {% if settings.accent_color_for_headings %}mega-menu__title--accent{% endif %} mega-menu__title--{{ settings.typography_preset }} {% if block.menu_heading_size != 'default' %}{{ block.menu_heading_size }}{% else %}{% if uppercase_font_title %} uppercase{% endif %}{% if bolder_font_title %} bolder-font{% endif %}{% endif %} {% if settings.show_lines %}mega-menu__title--lines{% endif %}">{{ final_text }}</h4>
        {% endif %}
        <div class="mega-menu__list-container {% if block.show_lines %}mega-menu__list-container--lines{% endif %}" data-columns="{{ block.columns }}">
            <ul class="menu__dropdown-child">
                {% for child_link in link.links %}
                    <li class="menu__dropdown-child-item {% if child_link.links.size > 0 %}has-child{% endif %}">
                        <div class="menu__item-title menu__item-title--second-level mega-menu__item-title--{{ settings.typography_preset }} {% if block.link_size != 'default' %}{{ block.link_size }}{% else %}{% if settings.navigation_item_size != 'default' %} {{ settings.navigation_item_size }}{% endif %}{% if uppercase_font %} uppercase{% endif %}{% if bolder_font %} bolder-font{% endif %}{% endif %}">
                            {% liquid 
                                assign downcased_link_title = child_link.title | downcase
                                assign downcased_highlighted_items = block.highlight_menu_item | downcase | split: ','
                                assign highlight_item = false
                                for highlighted_item in downcased_highlighted_items
                                    assign highlighted_item_strip = highlighted_item | strip
                                    if highlighted_item_strip == downcased_link_title
                                        assign highlight_item = true
                                    endif
                                endfor
                            %}
                            <a class="menu__dropdown-child-item-link hover-link{% if highlight_item %} link--highlighted{% endif %}" href="{{ child_link.url }}">
                                <div class="menu__item-link-title {% if settings.enable_animated_underline and settings.enable_rolling_hover == false %}link-animation--underline{% elsif settings.enable_rolling_hover %}link-animation--slide{% else %}link-animation{% endif %} {% if child_link.current and settings.underline_active_link == true %}underline-active{% endif %} {% if settings.enable_animated_underline and settings.enable_rolling_hover == false %}link-animation--underline{% elsif settings.enable_rolling_hover %}link-animation--slide{% else %}link-animation{% endif %}">
                                    <span data-hover="{{ child_link.title }}">{{ child_link.title }}</span>
                                </div>
                            </a>
                        </div>
                        {% if child_link.links.size > 0 %}
                            <div class="menu__dropdown-grandchild-container">
                                <ul class="menu__dropdown-grandchild">
                                {% for grandchild_link in child_link.links %}
                                    <li class="menu__dropdown-grandchild-item dim">
                                    {% liquid 
                                        assign downcased_link_title = grandchild_link.title | downcase
                                        assign downcased_highlighted_items = block.highlight_menu_item | downcase | split: ','
                                        assign highlight_item = false
                                        for highlighted_item in downcased_highlighted_items
                                            assign highlighted_item_strip = highlighted_item | strip
                                            if highlighted_item_strip == downcased_link_title
                                                assign highlight_item = true
                                            endif
                                        endfor
                                    %}
                                    <a class="menu__dropdown-grandchild-link hover-link mega-menu__child-item-title--{{ settings.typography_preset }} {% if block.link_size != 'default' %}{{ block.link_size }}{% else %}{% if uppercase_font %} uppercase{% endif %}{% if bolder_font %} bolder-font{% endif %}{% endif %} {% if highlight_item %} link--highlighted{% endif %}" href="{{ grandchild_link.url }}">
                                        <div class="menu__item-link-title {% if settings.enable_animated_underline and settings.enable_rolling_hover == false %}link-animation--underline{% elsif grandchild_link.current and settings.underline_active_link == true %}underline-active{% endif %} {% if settings.enable_animated_underline and settings.enable_rolling_hover == false %}link-animation--underline{% elsif settings.enable_rolling_hover %}link-animation--slide{% else %}link-animation{% endif %}">
                                            <span data-hover="{{ grandchild_link.title }}">{{ grandchild_link.title }}</span>
                                        </div>
                                    </a>
                                    </li>
                                {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            {% assign columns = block.columns | times: 1 %}
            {% if block.show_lines and columns == 2 %}
            <span class="mega-menu__line" data-index="1"></span>
            {% elsif block.show_lines and columns == 3 %}
            <span class="mega-menu__line" data-index="1"></span>
            <span class="mega-menu__line" data-index="2"></span>
            {% elsif block.show_lines and columns == 4 %}
            <span class="mega-menu__line" data-index="1"></span>
            <span class="mega-menu__line" data-index="2"></span>
            <span class="mega-menu__line" data-index="3"></span>
            {% endif %}
        </div>
    </div>
    {%- if block.show_banner -%}
        <div class="mega-menu__banner {% if block.swap_banner_position %}mega-menu__banner--left{% endif %} {% if block.show_lines %}mega-menu__banner--lines{% endif %}">
            {% liquid
                assign settings_page_width = settings.max_page_width | append: 'px'
                if settings.max_page_width == 'full_width'
                assign settings_page_width = '100vw'
                endif
                assign uppercase_font_subheading = false
                assign bolder_font_subheading = false
                if settings.typography_preset == 'custom'
                    if block.subheading_size == 'default'
                        if settings.uppercase_label
                                assign uppercase_font_subheading = true
                        endif
                        if settings.bolder_font_label
                                assign bolder_font_subheading = true
                        endif
                    endif
                endif
                assign uppercase_font_heading = false
                assign bolder_font_heading = false
                if settings.typography_preset == 'custom'
                    if block.heading_size == 'default'
                        if settings.uppercase_label
                                assign uppercase_font_heading = true
                        endif
                        if settings.bolder_font_label
                                assign bolder_font_heading = true
                        endif
                    endif
                endif
            %}
            {% if block.banner_link != blank %}<double-hover>{% endif %}
                <{% if block.banner_link != blank %}a{% else %}div{% endif %} class="mega-menu__banner-link double-hover"{% if block.banner_link != blank %} href="{{ block.banner_link }}"{% else %} role="link" aria-disabled="true"{% endif %}>
                    <div class="mega-menu__banner-image" {% if settings.disable_right_click %}oncontextmenu="return false"{% endif %}>
                        {%- if block.banner_image != blank -%}
                        {% if settings.images_loading != 'disable' %}
                            <figure class="lazy-image lazy-image--absolut lazy-image--{{ settings.images_loading }}">
                        {% endif %}
                            <img srcset="{%- if block.banner_image.image.width >= 165 -%}{{ block.banner_image.image | image_url: width: 165 }} 165w,{%- endif -%}
                            {%- if block.banner_image.image.width >= 375 -%}{{ block.banner_image.image | image_url: width: 375 }} 375w,{%- endif -%}
                            {%- if block.banner_image.image.width >= 550 -%}{{ block.banner_image.image | image_url: width: 550 }} 550w,{%- endif -%}
                            {%- if block.banner_image.image.width >= 750 -%}{{ block.banner_image.image | image_url: width: 750 }} 750w,{%- endif -%}
                            {%- if block.banner_image.image.width >= 1100 -%}{{ block.banner_image.image | image_url: width: 1100 }} 1100w,{%- endif -%}
                            {%- if block.banner_image.image.width >= 1500 -%}{{ block.banner_image.image | image_url: width: 1500 }} 1500w,{%- endif -%}
                            {{ block.banner_image.image | image_url }} {{ block.banner_image.image.width }}w" src="{{ block.banner_image.image | image_url: height: block.banner_image.image.width }}" 
                            loading="lazy"
                            {% if settings.images_loading != 'disable' %}
                                onload="this.parentNode.classList.add('lazyloaded');"
                            {% endif %}
                            draggable="false"
                            width="{{ block.banner_image.image.width }}" 
                            height="{{ block.banner_image.image.height }}" 
                            {% if block.width == 'narrow' %}
                                sizes="calc(960px / 2)"
                            {% else %}
                                sizes="(min-width: {{ settings_page_width }}) {{ settings_page_width }}, calc(100vw / 2)"
                            {% endif %}
                            alt="{{ block.banner_image.image.alt | default: shop.name | escape }}" 
                            class="image__item"
                            style="object-position: {{ block.banner_image.image.presentation.focal_point }}"/>
                        {% if settings.images_loading != 'disable' %}
                            {% if settings.images_loading != 'fade_scale' %}
                            <div class="lazy-image__preloader lazy-image__preloader-{{ settings.images_loading }}" aria-hidden="true">
                                <img 
                                alt="{{ block.banner_image.image.alt | escape }}" 
                                src="{{ block.banner_image.image | image_url: width: 10 }}"
                                draggable="false"
                                width="10" 
                                height="10">
                            </div>
                            {% endif %}
                            </figure>
                            {% endif %}
                        {% else %}
                            {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                        {%- endif -%}
                    </div>
                    {%- if block.subheading != blank or block.heading != blank or block.button_label != blank -%}
                        <div class="mega-menu__banner-content {% if block.horizontal_content_alignment == "center" %}mega-menu__banner-content--center{% endif %}">
                            <div class="mega-menu__banner-content-container">
                            {% if block.subheading != blank %}<h6 class="mega-menu__banner-subheading mega-menu__banner-subheading--{{ settings.typography_preset }} {% if block.subheading_size != 'default' %}{{ block.subheading_size }}{% else %}{% if uppercase_font_subheading %} uppercase{% endif %}{% if bolder_font_subheading %} bolder-font{% endif %}{% endif %}">{{ block.subheading }}</h6>{% endif %}
                            {% if block.heading != blank %}
                                {% liquid
                                    assign heading_text = block.heading
                                    assign final_text = ''
                                    assign split_text_curly = heading_text | split: '{'
                                    for part in split_text_curly
                                        if part contains '}'
                                            assign split_curly = part | split: '}'
                                            assign styled_text = split_curly[0]
                                            assign after_curly = split_curly[1]
                                            assign final_text = final_text | append: '<span class="styled">' | append: styled_text | append: '</span>' | append: after_curly
                                        else
                                            assign final_text = final_text | append: part
                                        endif
                                    endfor
                                  %}
                                <h5 class="mega-menu__banner-heading custom-heading mega-menu__banner-heading--{{ settings.typography_preset }} {% if block.heading_size != 'default' %}{{ block.heading_size }}{% else %}{% if uppercase_font_heading %} uppercase{% endif %}{% if bolder_font_heading %} bolder-font{% endif %}{% endif %}">{{ final_text }}</h5>
                            {% endif %}
                            </div>
                        </div>
                    {%- endif -%}
                </{% if block.banner_link != blank %}a{% else %}div{% endif %}>
            {% if block.banner_link != blank %}</double-hover>{% endif %}
        </div>
    {%- endif -%}
</div>